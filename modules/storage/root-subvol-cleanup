#!/usr/bin/env bash

if ! [[ "$KEEP_MIN" =~ ^[0-9]+$ ]] || ((KEEP_MIN < 1)); then
  echo "Error: KEEP_MIN must be a positive integer" >&2
  exit 1
fi

if ! [[ "$KEEP_DAYS" =~ ^[0-9]+$ ]] || ((KEEP_DAYS < 1)); then
  echo "Error: KEEP_DAYS must be a positive integer" >&2
  exit 1
fi

if ! mountpoint -q "$RAW_BTRFS_MP"; then
  echo "Error: $RAW_BTRFS_MP is not mounted" >&2
  exit 1
fi

delete_subvolume_recursively() {
  local subvol="$1"

  if ! btrfs subvolume show "$subvol" &>/dev/null; then
    echo "Warning: $subvol is not a btrfs subvolume, skipping" >&2
    return 1
  fi

  while IFS= read -r child; do
    if [[ -n "$child" ]]; then
      delete_subvolume_recursively "$RAW_BTRFS_MP/$child"
    fi
  done < <(btrfs subvolume list -o "$subvol" 2>/dev/null | awk '{print $NF}' || true)

  echo "Deleting subvolume: $subvol"
  if ! btrfs subvolume delete "$subvol"; then
    echo "Error: Failed to delete $subvol" >&2
    return 1
  fi
  return 0
}

mapfile -t subvols < <(
  find "$RAW_BTRFS_MP/$ROOT_SUBVOL_NAME" \
    -mindepth 1 -maxdepth 1 -type d \
    ! -name current \
    2>/dev/null || true
)

if ((${#subvols[@]} == 0)); then
  echo "No archived snapshots found"
  exit 0
fi
echo "Found ${#subvols[@]} archived snapshot(s)"

mapfile -t sorted_subvols < <(printf "%s\n" "${subvols[@]}" | sort)

total=${#sorted_subvols[@]}
now=$(date +%s)
deleted_count=0

for ((i = 0; i < total; i++)); do
  subvol="${sorted_subvols[i]}"
  basename=$(basename "$subvol")

  timestamp="${basename/_/ }"
  if ! subvol_epoch=$(date -d "$timestamp" +%s 2>/dev/null); then
    echo "Warning: Cannot parse timestamp from '$basename', skipping" >&2
    continue
  fi

  age_days=$(((now - subvol_epoch) / 86400))
  remaining=$((total - deleted_count - 1))

  if ((remaining >= KEEP_MIN && age_days > KEEP_DAYS)); then
    echo "Deleting '$basename' (age: ${age_days}d, remaining: ${remaining})"
    if delete_subvolume_recursively "$subvol"; then
      ((deleted_count++))
    fi
  else
    reason="?"
    if ((remaining < KEEP_MIN)); then
      reason="would fall below minimum threshold, KEEP_MIN=$KEEP_MIN"
    elif ((age_days <= KEEP_DAYS)); then
      reason="only ${age_days}d old (< KEEP_DAYS=$KEEP_DAYS)"
    fi
    echo "Keeping '$basename' ($reason)"
  fi
done

echo "Cleanup complete: deleted $deleted_count snapshot(s), $((total - deleted_count)) remaining"
